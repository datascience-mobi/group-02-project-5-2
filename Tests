promotors_normalized <- read.csv(file = "promoters_normalized.csv")

#PCA

#The data must be turned into a matrx to use the fucntion prcomp (Principal components)

promotors_matrix <- as.matrix(promotors_normalized) 

class(promotors_matrix)

#Beta values of 0 and 1 have been respectively turned into -Inf and Inf values, the PCA is not able to work with these values
#Ina and -Inf values are turned turned into extremely low/high values for M values, respectively -20 and 20

promotors_matrix_noInf <- promotors_matrix

promotors_matrix_noInf[which(promotors_matrix_noInf == Inf)] <- 20
promotors_matrix_noInf[which(promotors_matrix_noInf == -Inf)] <- -20

#In order to simplify our dataset the names of the sample are turned into intuitive names

colnames(promotors_matrix_noInf) <- c(
  paste("AML", 1:9, sep=""),
  paste("CON", 1:9, sep=""))

View(promotors_matrix_noInf)

#The PCA is run

promotors_pca <- prcomp(t(promotors_matrix_noInf), scale = TRUE)

sample_annotation <- read.csv(file="sample_annotation.csv")

#we create a dataframe with possible sources of variation and the PCs to inspect them closely 
# for now we want to inspect the effects that can be quantified with the kruskal-wallis test 

pca_promotors <- promotors_pca$x

PatientInfo_kruskal <- sample_annotation[,c(3,28,29,33)]

kruskal_df <-cbind(PatientInfo_kruskal,pca_promotors)
colnames(kruskal_df) <- c(1:22)


# we want to apply the kruskal wallis test on PC1-5(col 5-10 in the data frame)
# with the effects cellType, Disease, Donor-ID and Biomaterial_Provider (col 1-4 in data frame)


# we create a matrix with p.values with PCs as coloumns and the effects as rows
heatmap_kruskal <- matrix(nrow=4,ncol=5)

for (j in 1:4){
  for (i in 5:10) {
    heatmap_kruskal[j,i-5] <- kruskal.test(kruskal_df[,i] ~ kruskal_df[,j], data = kruskal_df)$p.value
    
  }
}
# now we create a similiar matrix with the statistic value

kruskal_statistic <- matrix(nrow=4,ncol=5)

for (j in 1:4){
  for (i in 5:10) {
    kruskal_statistic[j,i-5] <- kruskal.test(kruskal_df[,i] ~ kruskal_df[,j], data = kruskal_df)[["statistic"]][["Kruskal-Wallis chi-squared"]]
    
  }
}

# now we want to aplly the wilcoxon-rank sum test on the same PCs with the effect gender

gender <- sample_annotation[,36]
wilcoxon_df <- cbind(gender,pca_promotors)
colnames(Wilcoxon_df) <- c(1:19)

# with this code wa have a matrix with the p.values 
heatmap_wilcoxon <- matrix(nrow=1,ncol=5)

  for (i in 2:7) {
    heatmap_wilcoxon[1,i-2] <- wilcox.test(wilcoxon_df[,i] ~ wilcoxon_df[,1], data = wilcoxon_df)$p.value
    
  }
# and here the statistic_values

wilcoxon_statistic <- matrix(nrow=1,ncol=5)


  for (i in 2:7) {
    wilcoxon_statistic[1,i-2] <- wilcox.test(wilcoxon_df[,i] ~ wilcoxon_df[,1], data = wilcoxon_df)[["statistic"]][["W"]]
    
  }

